<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:metal="http://xml.zope.org/namespaces/metal"
      xmlns:tal="http://xml.zope.org/namespaces/tal"
      xmlns:i18n="http://xml.zope.org/namespaces/i18n"
      metal:use-macro="context/main_template/macros/master"
      i18n:domain="plone.app.discussion">

<head>
    <title metal:fill-slot="title" i18n:translate="title_ban_management">User Ban Management</title>
</head>

<body>

<metal:override fill-slot="top_slot">
  <tal:block define="dummy python:request.set('disable_border', 1);
                     dummy python:request.set('disable_plone.leftcolumn', 1);
                     dummy python:request.set('disable_plone.rightcolumn', 1)" />
</metal:override>

<metal:main fill-slot="main">
    <div class="container-fluid px-0">
        <!-- Header section with icon and description -->
        <div class="d-flex align-items-center mb-4">
            <div>
                <h1 class="documentFirstHeading mb-0" i18n:translate="title_ban_management">User Ban Management</h1>
                <div class="documentDescription text-muted" i18n:translate="ban_management_description">
                    Manage user bans to control access to commenting. View active bans, create new restrictions, and monitor ban statistics.
                </div>
            </div>
        </div>

        <!-- Search and filter form in a card -->
        <div class="card mb-4">
            <div class="card-header bg-light d-flex align-items-center">
                <span i18n:translate="heading_search_filter">Search and Filter Bans</span>
            </div>
            <div class="card-body py-3">
                <form method="get" tal:attributes="action string:${context/absolute_url}/@@ban-management"
                      class="search-box">
                    <div class="row g-3">
                        <!-- Search field -->
                        <div class="col-md-6">
                            <label for="search-query" class="form-label" i18n:translate="label_search_users">Search users</label>
                            <div class="input-group">
                                <input type="text" name="search_query" id="search-query" 
                                       tal:attributes="value request/search_query|nothing"
                                       class="form-control" 
                                       placeholder="Search by user ID, moderator, or reason..." 
                                       i18n:attributes="placeholder" />
                                <button class="btn btn-primary" type="submit">
                                    <span i18n:translate="button_search">Search</span>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Filter & Sort Options -->
                        <div class="col-md-6">
                            <div class="row g-2">
                                <!-- Ban Type Filter -->
                                <div class="col-sm-6" tal:define="current_filter request/filter_type|nothing">
                                    <label for="filter-type" class="form-label" i18n:translate="label_ban_type_filter">Ban type</label>
                                    <select id="filter-type" name="filter_type" class="form-select" onchange="this.form.submit()">
                                        <option value="" i18n:translate="option_all_ban_types">All ban types</option>
                                        <option value="cooldown" 
                                                tal:attributes="selected python:current_filter == 'cooldown'"
                                                i18n:translate="option_cooldown">Cooldown Ban</option>
                                        <option value="shadow" 
                                                tal:attributes="selected python:current_filter == 'shadow'"
                                                i18n:translate="option_shadow">Shadow Ban</option>
                                        <option value="permanent" 
                                                tal:attributes="selected python:current_filter == 'permanent'"
                                                i18n:translate="option_permanent">Permanent Ban</option>
                                    </select>
                                </div>
                                
                                <!-- Sort Order -->
                                <div class="col-sm-6" tal:define="current_sort request/sort_by|string:date_desc">
                                    <label for="sort-by" class="form-label" i18n:translate="label_sort_by">Sort by</label>
                                    <select id="sort-by" name="sort_by" class="form-select" onchange="this.form.submit()">
                                        <option value="date_desc" 
                                                tal:attributes="selected python:current_sort == 'date_desc'"
                                                i18n:translate="sort_newest_first">Newest first</option>
                                        <option value="date_asc" 
                                                tal:attributes="selected python:current_sort == 'date_asc'"
                                                i18n:translate="sort_oldest_first">Oldest first</option>
                                        <option value="user_asc" 
                                                tal:attributes="selected python:current_sort == 'user_asc'"
                                                i18n:translate="sort_user_az">User (A-Z)</option>
                                        <option value="user_desc" 
                                                tal:attributes="selected python:current_sort == 'user_desc'"
                                                i18n:translate="sort_user_za">User (Z-A)</option>
                                        <option value="expires_asc" 
                                                tal:attributes="selected python:current_sort == 'expires_asc'"
                                                i18n:translate="sort_expires_soon">Expires soon</option>
                                        <option value="expires_desc" 
                                                tal:attributes="selected python:current_sort == 'expires_desc'"
                                                i18n:translate="sort_expires_later">Expires later</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Combined notification for search, filter and sort -->
        <div tal:define="search_query request/search_query|nothing;
                         filter_type request/filter_type|nothing;
                         sort_option request/sort_by|string:date_desc;
                         has_active_filters python:search_query or filter_type or (sort_option != 'date_desc')"
             tal:condition="has_active_filters"
             class="alert alert-info d-flex align-items-center mb-4">
             
            <div class="ms-1 d-flex flex-grow-1 flex-wrap align-items-center gap-2">
                <span i18n:translate="active_filters_label" class="fw-bold me-2">Active filters:</span>
                
                <span tal:condition="search_query" class="badge rounded-pill bg-primary d-inline-flex align-items-center p-2">
                    <span tal:content="search_query" class="me-1">query</span>
                    <a href="#" tal:attributes="href python:request.URL + '?' + '&'.join([f'{k}={v}' for k,v in request.form.items() if k != 'search_query'])"
                       class="text-white ms-1" style="text-decoration: none;" 
                       title="Clear search" i18n:attributes="title">
                       ×
                    </a>
                </span>
                
                <span tal:condition="filter_type" class="badge rounded-pill bg-primary d-inline-flex align-items-center p-2">
                    <span tal:content="filter_type" class="me-1">Type</span>
                    <a href="#" tal:attributes="href python:request.URL + '?' + '&'.join([f'{k}={v}' for k,v in request.form.items() if k != 'filter_type'])"
                       class="text-white ms-1" style="text-decoration: none;" 
                       title="Clear filter" i18n:attributes="title">
                       ×
                    </a>
                </span>
                
                <span tal:condition="python:sort_option != 'date_desc'" class="badge rounded-pill bg-primary d-inline-flex align-items-center p-2">
                    <span tal:content="sort_option" class="me-1">Sort</span>
                    <a href="#" tal:attributes="href python:request.URL + '?' + '&'.join([f'{k}={v}' for k,v in request.form.items() if k != 'sort_by'])"
                       class="text-white ms-1" style="text-decoration: none;" 
                       title="Reset sort" i18n:attributes="title">
                       ×
                    </a>
                </span>
            </div>
            
            <a tal:attributes="href string:${context/absolute_url}/@@ban-management"
               class="btn btn-sm btn-outline-secondary ms-auto" i18n:translate="button_clear_all">
                Clear all
            </a>
        </div>

        <!-- Ban Statistics and Quick Actions Row -->
        <div class="row mb-4 g-3">
            <!-- Ban Statistics -->
            <div class="col-lg-6">
                <div class="card h-100">
                    <div class="card-header bg-light">
                        <span i18n:translate="heading_ban_statistics">Ban Statistics</span>
                    </div>
                    <div class="card-body py-3">
                        <div class="row text-center">
                            <div class="col-4">
                                <div class="border-end pe-3">
                                    <h5 class="text-info mb-1" tal:content="python:len([b for b in view.get_active_bans() if b.ban_type == 'cooldown'])">0</h5>
                                    <small class="text-muted" i18n:translate="stat_cooldown">Cooldown</small>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="border-end pe-3">
                                    <h5 class="text-warning mb-1" tal:content="python:len([b for b in view.get_active_bans() if b.ban_type == 'shadow'])">0</h5>
                                    <small class="text-muted" i18n:translate="stat_shadow">Shadow</small>
                                </div>
                            </div>
                            <div class="col-4">
                                <h5 class="text-danger mb-1" tal:content="python:len([b for b in view.get_active_bans() if b.ban_type == 'permanent'])">0</h5>
                                <small class="text-muted" i18n:translate="stat_permanent">Permanent</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="col-lg-6">
                <div class="card h-100">
                    <div class="card-header bg-light">
                        <span i18n:translate="heading_quick_actions">Quick Actions</span>
                    </div>
                    <div class="card-body py-3 d-flex flex-column">
                        <div class="d-grid gap-2 flex-grow-1">
                            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#banUserModal">
                                <span i18n:translate="button_ban_user">Ban User</span>
                            </button>
                        </div>
                        <div class="text-center mt-2">
                            <small class="text-muted" i18n:translate="quick_action_help">
                                Quickly restrict a user's access
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main content card -->
        <div class="card">
            <div class="card-header bg-light">
                <div class="d-flex align-items-center justify-content-between">
                    <div>
                        <span i18n:translate="heading_active_bans">Active Bans</span>
                    </div>
                    <div tal:define="bans view/get_active_bans">
                        <span class="badge bg-secondary" tal:content="python:len(bans)">0</span>
                        <span i18n:translate="label_bans">bans</span>
                    </div>
                </div>
            </div>
            
            <!-- Main form for ban management -->
            <form id="ban-management-form"
                  method="post"
                  tal:define="bans view/get_active_bans"
                  tal:condition="bans"
                  enctype="multipart/form-data"
                  tal:attributes="action request/URL;">

                <input tal:replace="structure context/@@authenticator/authenticator" />
                
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th width="40">
                                        <div class="form-check">
                                            <input type="checkbox" class="form-check-input" name="select_all" id="select_all" 
                                                   aria-label="Select all bans" title="Select all bans"
                                                   i18n:attributes="title;aria-label" />
                                            <label class="form-check-label visually-hidden" for="select_all" i18n:translate="label_select_all">Select all</label>
                                        </div>
                                    </th>
                                    <th i18n:translate="th_user">User</th>
                                    <th i18n:translate="th_ban_type">Ban Type</th>
                                    <th i18n:translate="th_created">Created</th>
                                    <th i18n:translate="th_expires">Expires</th>
                                    <th i18n:translate="th_remaining">Remaining</th>
                                    <th i18n:translate="th_reason">Reason</th>
                                    <th i18n:translate="th_moderator">Moderator</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr tal:repeat="ban bans">
                                    <td>
                                        <div class="form-check">
                                            <input type="checkbox" name="selected_bans:list" 
                                                   class="form-check-input ban-checkbox"
                                                   tal:attributes="value ban/user_id;
                                                                  id string:ban-${ban/user_id}" />
                                            <label class="form-check-label visually-hidden" 
                                                   tal:attributes="for string:ban-${ban/user_id}" 
                                                   i18n:translate="label_select_ban">Select ban</label>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <span tal:content="python: view.get_user_display_name(ban.user_id)">User</span>
                                        </div>
                                    </td>
                                    <td>
                                        <span class="badge rounded-pill" 
                                              tal:attributes="class python: 'badge rounded-pill bg-danger' if ban.ban_type == 'permanent' else ('badge rounded-pill bg-warning text-dark' if ban.ban_type == 'shadow' else 'badge rounded-pill bg-info')"
                                              tal:content="python: view.get_ban_type_display(ban.ban_type)">Ban Type</span>
                                    </td>
                                    <td>
                                        <span tal:content="python: ban.created_date.strftime('%Y-%m-%d %H:%M')">Created</span>
                                    </td>
                                    <td>
                                        <span tal:condition="ban/expires_date" 
                                               tal:content="python: ban.expires_date.strftime('%Y-%m-%d %H:%M')">Expires</span>
                                        <span class="badge bg-dark" tal:condition="not: ban/expires_date" i18n:translate="never">Never</span>
                                    </td>
                                    <td>
                                        <span class="fw-bold text-warning" tal:content="python: view.format_time_remaining(ban)">Remaining</span>
                                    </td>
                                    <td>
                                        <span class="text-truncate d-inline-block" style="max-width: 200px;" 
                                              tal:content="ban/reason | string:No reason provided"
                                              tal:attributes="title ban/reason | string:No reason provided">Reason</span>
                                    </td>
                                    <td>
                                        <span class="text-muted" tal:content="ban/moderator_id">Moderator</span>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Button group for selected bans actions -->
                <div tal:condition="bans" class="card-footer bg-light py-3">
                    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                        <div class="btn-group" role="group">
                            <button type="submit" name="action" value="unban_selected" class="btn btn-success" i18n:translate="button_unban_selected">
                                <span>Unban Selected</span>
                            </button>
                            <button type="submit" name="action" value="cleanup_expired" class="btn btn-outline-warning" i18n:translate="button_cleanup_expired">
                                <span>Cleanup Expired</span>
                            </button>
                        </div>
                        
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#quickUnbanModal" i18n:translate="button_quick_unban">
                                <span>Quick Unban</span>
                            </button>
                        </div>
                    </div>
                </div>
            </form>
            
            <!-- Empty state if no bans -->
            <div tal:define="bans view/get_active_bans" tal:condition="not:bans" class="card-body">
                <div class="text-center py-5">
                    <p class="fw-bold" tal:condition="python:request.get('search_query') or request.get('filter_type')" i18n:translate="no_bans_match_criteria">
                        No bans match your search criteria
                    </p>
                    <p class="fw-bold" tal:condition="python:not request.get('search_query') and not request.get('filter_type')" i18n:translate="no_active_bans">
                        No active bans found
                    </p>
                    <p class="text-muted" i18n:translate="no_active_bans_description">There are currently no active user bans. Users can comment freely.</p>
                </div>
            </div>
        </div>
        <!-- Ban User Modal -->
        <div class="modal fade" id="banUserModal" tabindex="-1" aria-labelledby="banUserModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header bg-danger text-white">
                        <h5 class="modal-title" id="banUserModalLabel">
                            <span i18n:translate="heading_ban_user">Ban User</span>
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <form method="post" class="needs-validation" novalidate>
                        <div class="modal-body">
                            <input type="hidden" name="action" value="ban_user" />
                            <input tal:replace="structure context/@@authenticator/authenticator" />
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="user_id" class="form-label" i18n:translate="label_user_id">User ID</label>
                                        <input type="text" 
                                               id="user_id" 
                                               name="user_id" 
                                               class="form-control" 
                                               required="required"
                                               placeholder="Enter username or user ID"
                                               i18n:attributes="placeholder" />
                                        <div class="invalid-feedback" i18n:translate="error_user_id_required">
                                            Please provide a valid user ID.
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="ban_type" class="form-label" i18n:translate="label_ban_type">Ban Type</label>
                                        <select id="ban_type" name="ban_type" class="form-select">
                                            <option value="cooldown" i18n:translate="option_cooldown">Cooldown Ban</option>
                                            <option value="shadow" i18n:translate="option_shadow">Shadow Ban</option>
                                            <option value="permanent" i18n:translate="option_permanent">Permanent Ban</option>
                                        </select>
                                        <div class="form-text">
                                            <small i18n:translate="help_ban_type">
                                                Cooldown: temporary ban, Shadow: comments hidden, Permanent: indefinite ban
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mb-3" id="duration_field">
                                <label for="duration_hours" class="form-label" i18n:translate="label_duration_hours">Duration (hours)</label>
                                <div class="input-group">
                                    <input type="number" 
                                           id="duration_hours" 
                                           name="duration_hours" 
                                           class="form-control" 
                                           min="1" 
                                           value="24" />
                                    <span class="input-group-text">hours</span>
                                </div>
                                <div class="form-text">
                                    <small i18n:translate="help_duration">Leave empty to use default duration for the selected ban type</small>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="reason" class="form-label" i18n:translate="label_reason">Reason</label>
                                <textarea id="reason" 
                                          name="reason" 
                                          class="form-control" 
                                          rows="3" 
                                          placeholder="Provide a reason for this ban (optional)"
                                          i18n:attributes="placeholder"></textarea>
                                <div class="form-text">
                                    <small i18n:translate="help_reason">This reason will be shown to the user and stored for moderation records</small>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                <span i18n:translate="button_cancel">Cancel</span>
                            </button>
                            <button type="submit" class="btn btn-danger">
                                <span i18n:translate="button_ban_user">Ban User</span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Quick Unban Modal -->
        <div class="modal fade" id="quickUnbanModal" tabindex="-1" aria-labelledby="quickUnbanModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header bg-success text-white">
                        <h5 class="modal-title" id="quickUnbanModalLabel">
                            <span i18n:translate="heading_unban_user">Unban User</span>
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <form method="post" class="needs-validation" novalidate>
                        <div class="modal-body">
                            <input type="hidden" name="action" value="unban_user" />
                            <input tal:replace="structure context/@@authenticator/authenticator" />
                            
                            <div class="mb-3">
                                <label for="unban_user_id" class="form-label" i18n:translate="label_user_id">User ID</label>
                                <input type="text" 
                                       id="unban_user_id" 
                                       name="unban_user_id" 
                                       class="form-control" 
                                       required="required"
                                       placeholder="Enter username or user ID to unban"
                                       i18n:attributes="placeholder" />
                                <div class="invalid-feedback" i18n:translate="error_user_id_required">
                                    Please provide a valid user ID.
                                </div>
                                <div class="form-text">
                                    <small i18n:translate="help_unban">This will remove all active bans for the specified user</small>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                <span i18n:translate="button_cancel">Cancel</span>
                            </button>
                            <button type="submit" class="btn btn-success">
                                <span i18n:translate="button_unban_user">Unban User</span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</metal:main>

<metal:js fill-slot="javascript_head_slot">
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Select all checkbox functionality
    const selectAllCheckbox = document.getElementById('select_all');
    
    if (selectAllCheckbox) {
        // Find all ban checkboxes
        const banCheckboxes = document.querySelectorAll('.ban-checkbox');
        
        // Update select all checkbox when ban checkboxes change
        function updateSelectAllCheckbox() {
            if (banCheckboxes.length === 0) return;
            
            let allChecked = true;
            for (const checkbox of banCheckboxes) {
                if (!checkbox.checked) {
                    allChecked = false;
                    break;
                }
            }
            selectAllCheckbox.checked = allChecked;
        }
        
        // Toggle all checkboxes when select all changes
        selectAllCheckbox.addEventListener('change', function() {
            const isChecked = this.checked;
            banCheckboxes.forEach(checkbox => {
                checkbox.checked = isChecked;
            });
        });
        
        // Update select all when individual checkboxes change
        banCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', updateSelectAllCheckbox);
        });
    }

    // Duration field toggle for ban type
    function toggleDurationField() {
        const banType = document.getElementById('ban_type');
        const durationField = document.getElementById('duration_field');
        
        if (banType && durationField) {
            if (banType.value === 'permanent') {
                durationField.style.display = 'none';
            } else {
                durationField.style.display = 'block';
            }
        }
    }
    
    // Initialize duration field visibility
    toggleDurationField();
    
    // Add event listener to ban type select
    const banTypeSelect = document.getElementById('ban_type');
    if (banTypeSelect) {
        banTypeSelect.addEventListener('change', toggleDurationField);
    }

    // Form validation
    const forms = document.querySelectorAll('.needs-validation');
    Array.from(forms).forEach(form => {
        form.addEventListener('submit', event => {
            if (!form.checkValidity()) {
                event.preventDefault();
                event.stopPropagation();
            }
            form.classList.add('was-validated');
        }, false);
    });

    // Confirmation for bulk unban actions
    const unbanSelectedButton = document.querySelector('button[value="unban_selected"]');
    if (unbanSelectedButton) {
        unbanSelectedButton.addEventListener('click', function(e) {
            const checkedBoxes = document.querySelectorAll('.ban-checkbox:checked');
            if (checkedBoxes.length === 0) {
                e.preventDefault();
                alert('Please select at least one ban to unban.');
                return;
            }
            
            if (!confirm('Are you sure you want to unban the selected users?')) {
                e.preventDefault();
            }
        });
    }

    // Enhanced table row highlighting
    const tableRows = document.querySelectorAll('.table tbody tr');
    tableRows.forEach(row => {
        row.addEventListener('mouseenter', function() {
            this.style.backgroundColor = '#f8f9fa';
        });
        row.addEventListener('mouseleave', function() {
            this.style.backgroundColor = '';
        });
    });
});
</script>
</metal:js>

</body>
</html>
